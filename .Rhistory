"color_by_post", "Color mapping (for points plot):",
choices = c("Home vs Away"      = "side",
"Make vs Miss"      = "outcome",
"One color (count)" = "one_color"),
selected = "side"
)
),
tabPanel(
"Court window",
br(),
sliderInput(
"xrange_post", "Court X‑range (length):",
min   = floor(x_limits[1]),
max   = ceiling(x_limits[2]),
value = x_limits
),
sliderInput(
"yrange_post", "Court Y‑range (width):",
min   = floor(y_limits[1]),
max   = ceiling(y_limits[2]),
value = y_limits
)
)
)
),
mainPanel(
width = 9,
plotOutput("plot_post", height = "550px"),
hr(),
h4("Summary for current filters"),
tableOutput("stats_post")
)
)
)
)
)
## ---------------------------------------------------------------
## 3. SERVER
## ---------------------------------------------------------------
server <- function(input, output, session) {
## ------------ HELPER: generic filter function ------------
filter_data <- function(era = c("pre", "post")) {
era <- match.arg(era)
if (era == "pre") {
shot_result <- input$shot_result_pre
season      <- input$season_pre
value       <- input$value_pre
team        <- input$team_pre
player      <- input$player_pre
xrange      <- input$xrange_pre
yrange      <- input$yrange_pre
} else {
shot_result <- input$shot_result_post
season      <- input$season_post
value       <- input$value_post
team        <- input$team_post
player      <- input$player_post
xrange      <- input$xrange_post
yrange      <- input$yrange_post
}
# Start from the correct base dataset (all / made / missed)
base <- pick_dataset(shot_result)
df <- base %>%
filter(season == season)
# Filter by shot value (3 / 2 / all)
if (value == "3") {
df <- df %>% filter(three_pt == "TRUE")
} else if (value == "2") {
df <- df %>% filter(three_pt == "FALSE")
}
# Team filter
if (!is.null(team) && team != "All teams") {
df <- df %>% filter(shot_team == team)
}
# Player filter
if (!is.null(player) && player != "All players") {
df <- df %>% filter(shooter == player)
}
# Add side (Home / Away) for coloring
df <- df %>%
mutate(
side = if_else(shot_team == home, "Home", "Away")
)
# Court window filter
df <- df %>%
filter(
dplyr::between(shot_x, xrange[1], xrange[2]),
dplyr::between(shot_y, yrange[1], yrange[2])
)
# Drop *exact* duplicate rows (helps with accidental doubling)
df <- df %>% distinct()
df
}
## ------------ PRE ERA REACTIVES & OUTPUTS ------------
data_pre <- reactive({
filter_data("pre")
})
output$plot_pre <- renderPlot({
df <- data_pre()
if (nrow(df) == 0) return(NULL)
if (input$plot_type_pre == "points") {
make_scatter_plot(
df,
plot_title = paste("Shot Locations —", input$season_pre),
color_by   = input$color_by_pre,
x_limits   = x_limits,
y_limits   = y_limits
)
} else {
ggplot(df, aes(x = shot_x, y = shot_y)) +
stat_bin2d(bins = 1000) +  # higher density = darker
scale_fill_viridis_c(option = "C", trans = "sqrt") +
coord_fixed(xlim = x_limits, ylim = y_limits) +
theme_minimal() +
labs(
title = paste("Shot Density —", input$season_pre),
x = "Court length (x)",
y = "Court width (y)",
fill = "Shot count"
)
}
})
output$stats_pre <- renderTable({
df <- data_pre()
if (nrow(df) == 0) return(NULL)
made_flag <- df$shot_outcome == "made"
made_num  <- as.numeric(made_flag)
# Simple correlations: location vs made
cor_x <- suppressWarnings(cor(df$shot_x, made_num, use = "complete.obs"))
cor_y <- suppressWarnings(cor(df$shot_y, made_num, use = "complete.obs"))
tibble(
Metric = c(
"Attempts",
"Makes",
"Misses",
"FG% (makes / attempts)",
"Correlation(shot_x, made)",
"Correlation(shot_y, made)"
),
Value = c(
nrow(df),
sum(made_flag, na.rm = TRUE),
sum(!made_flag, na.rm = TRUE),
sprintf("%.1f%%", 100 * mean(made_flag, na.rm = TRUE)),
round(cor_x, 3),
round(cor_y, 3)
)
)
})
## ------------ POST ERA REACTIVES & OUTPUTS ------------
data_post <- reactive({
filter_data("post")
})
output$plot_post <- renderPlot({
df <- data_post()
if (nrow(df) == 0) return(NULL)
if (input$plot_type_post == "points") {
make_scatter_plot(
df,
plot_title = paste("Shot Locations —", input$season_post),
color_by   = input$color_by_post,
x_limits   = x_limits,
y_limits   = y_limits
)
} else {
ggplot(df, aes(x = shot_x, y = shot_y)) +
stat_bin2d(bins = 1000) +
scale_fill_viridis_c(option = "C", trans = "sqrt") +
coord_fixed(xlim = x_limits, ylim = y_limits) +
theme_minimal() +
labs(
title = paste("Shot Density —", input$season_post),
x = "Court length (x)",
y = "Court width (y)",
fill = "Shot count"
)
}
})
output$stats_post <- renderTable({
df <- data_post()
if (nrow(df) == 0) return(NULL)
made_flag <- df$shot_outcome == "made"
made_num  <- as.numeric(made_flag)
cor_x <- suppressWarnings(cor(df$shot_x, made_num, use = "complete.obs"))
cor_y <- suppressWarnings(cor(df$shot_y, made_num, use = "complete.obs"))
tibble(
Metric = c(
"Attempts",
"Makes",
"Misses",
"FG% (makes / attempts)",
"Correlation(shot_x, made)",
"Correlation(shot_y, made)"
),
Value = c(
nrow(df),
sum(made_flag, na.rm = TRUE),
sum(!made_flag, na.rm = TRUE),
sprintf("%.1f%%", 100 * mean(made_flag, na.rm = TRUE)),
round(cor_x, 3),
round(cor_y, 3)
)
)
})
}
shinyApp(ui, server)
shiny(ui, server())
shiny(ui, server)
library(shiny))
library(shiny)
shiny(ui, server)
View(shots_all)
ggplot(shots_all, aes(x = shot_x)) +
geom_density() +
labs(title = "Density of Shot X",
x = "Shot X")
library(ggplot2)
library(tidyverse)
ggplot(shots_all, aes(x = shot_x)) +
geom_density() +
labs(title = "Density of Shot X",
x = "Shot X")
library(ggplot2)
ggplot(shots_all, aes(x = shot_x)) +
geom_histogram(binwidth = 5) +   # adjust binwidth as needed
labs(title = "Distribution of Shot X Coordinates",
x = "Shot X",
y = "Frequency")
shots_normal <- shots_all|>
filter(three_pt == FALSE, free_throw == FALSE)
View(shots_normal)
ggplot(shots_normal, aes(x = shot_x)) +
geom_histogram(binwidth = 3)
shot_summary <- shots_normal %>%
group_by(shot_x, shot_y) %>%
summarise(
attempts = n(),
makes = sum(shot_outcome == "made"),
success_rate = makes / attempts,
.groups = "drop"
)
View(shot_summary)
shots_normal %>%
distinct(shot_x, shot_y) %>%
nrow()
shots_normal %>%
distinct(shot_x, shot_y)
shots_normal <- shots_normal %>%
mutate(
shot_x = round(shot_x, 1),
shot_y = round(shot_y, 1)
)
shot_summary <- shots_normal %>%
group_by(shot_x, shot_y) %>%
summarise(
attempts = n(),
makes = sum(shot_outcome == "made"),
success_rate = makes / attempts,
.groups = "drop"
)
shot_summary |> arrange(desc(sucess_rate))
shot_summary |> arrange(desc(success_rate))
shot_summary <- shot_summary |> arrange(desc(success_rate))
shots_normal <- shots_all|>
filter(free_throw == FALSE)
shots_normal <- shots_normal %>%
mutate(
shot_x = round(shot_x, 1),
shot_y = round(shot_y, 1)
)
shot_summary <- shots_normal %>%
group_by(shot_x, shot_y) %>%
summarise(
attempts = n(),
makes = sum(shot_outcome == "made"),
success_rate = makes / attempts,
.groups = "drop"
)
library(dplyr)
mu <- shots_all %>%
summarize(p = mean(shot_outcome == "made")) %>%
pull(p)
K <- 35
alpha <- mu * K
beta  <- (1 - mu) * K
alpha; beta
shot_summary <- shot_summary %>%
mutate(
shrunk_rate = (makes + alpha) / (attempts + alpha + beta)
)
shot_summary <- shot_summary |> arrange(desc(shrunk_rate))
ggplot(shot_summary, aes(x = shot_x, y = shot_y, color = shrunk_rate)) +
geom_point(alpha = 0.8, size = 2) +
scale_color_viridis_c(option = "magma") +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Shrunk Rate)",
x = "Shot X",
y = "Shot Y",
color = "Shrunk FG%"
) +
theme_minimal()
ggplot(shot_summary, aes(x = shot_x, y = shot_y, color = shrunk_rate)) +
geom_point(alpha = 0.2, size = 2) +
scale_color_viridis_c(option = "magma") +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Shrunk Rate)",
x = "Shot X",
y = "Shot Y",
color = "Shrunk FG%"
) +
theme_minimal()
ggplot(shot_summary, aes(x = shot_x, y = shot_y, color = shrunk_rate)) +
geom_point(alpha = 0.8, size = 1) +
scale_color_viridis_c(option = "magma") +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Shrunk Rate)",
x = "Shot X",
y = "Shot Y",
color = "Shrunk FG%"
) +
theme_minimal()
ggplot(shot_summary, aes(x = shot_x, y = shot_y, color = shrunk_rate)) +
geom_point(alpha = 0.2, size = 3) +
scale_color_viridis_c(option = "magma") +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Shrunk Rate)",
x = "Shot X",
y = "Shot Y",
color = "Shrunk FG%"
) +
theme_minimal()
ggplot(shot_summary, aes(x = shot_x, y = shot_y, color = shrunk_rate)) +
geom_point(alpha = 0.4, size = 3) +
scale_color_viridis_c(option = "magma") +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Shrunk Rate)",
x = "Shot X",
y = "Shot Y",
color = "Shrunk FG%"
) +
theme_minimal()
ggplot(shot_summary, aes(
x = shot_x,
y = shot_y,
color = shrunk_rate,
size = attempts
)) +
geom_point(alpha = 0.3) +
scale_color_viridis_c(option = "magma") +
scale_size(range = c(1, 8)) +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Sized by Attempts)",
color = "Shrunk FG%",
size = "Attempts"
) +
theme_minimal()
ggplot(shot_summary, aes(
x = shot_x,
y = shot_y,
color = shrunk_rate,
size = attempts
)) +
geom_point(alpha = 0.5) +
scale_color_viridis_c(option = "magma") +
scale_size(range = c(1, 8)) +
coord_fixed() +
labs(
title = "Shot Efficiency Heatmap (Sized by Attempts)",
color = "Shrunk FG%",
size = "Attempts"
) +
theme_minimal()
make_shot_summary <- function(data,
season = NULL,
player = NULL,
min_attempts = 1,
K = 35) {
library(dplyr)
# ---- Compute overall FG% for empirical Bayes prior ----
mu <- mean(data$shot_outcome == "made")
alpha <- mu * K
beta  <- (1 - mu) * K
# ---- Build summary table ----
summary_df <- data %>%
group_by(shot_x, shot_y) %>%
summarise(
attempts = n(),
makes = sum(shot_outcome == "made"),
success_rate = makes / attempts,
.groups = "drop"
) %>%
filter(attempts >= min_attempts) %>%
mutate(
shrunk_rate = (makes + alpha) / (attempts + alpha + beta),
alpha = alpha,
beta = beta,
global_fg = mu
)
return(summary_df)
}
make_shot_summary <- function(data,
season = NULL,
player = NULL,
min_attempts = 1,
K = 50) {
library(dplyr)
# Optional filtering
if (!is.null(season)) {
data <- data %>% filter(season == season)
}
if (!is.null(player)) {
data <- data %>% filter(shooter == player)
}
# Overall FG% for empirical Bayes prior
mu <- mean(data$shot_outcome == "made")
alpha <- mu * K
beta  <- (1 - mu) * K
# Per-location summary
summary_df <- data %>%
group_by(shot_x, shot_y) %>%
summarise(
attempts = n(),
makes = sum(shot_outcome == "made"),
success_rate = makes / attempts,
.groups = "drop"
) %>%
filter(attempts >= min_attempts) %>%
mutate(
shrunk_rate = (makes + alpha) / (attempts + alpha + beta),
alpha = alpha,
beta = beta,
global_fg = mu
)
return(summary_df)
}
make_shot_summary <- function(data,
season = NULL,
player = NULL,
min_attempts = 1,
K = 35) {
library(dplyr)
# Optional filtering
if (!is.null(season)) {
data <- data %>% filter(season == season)
}
if (!is.null(player)) {
data <- data %>% filter(shooter == player)
}
# Overall FG% for empirical Bayes prior
mu <- mean(data$shot_outcome == "made")
alpha <- mu * K
beta  <- (1 - mu) * K
# Per-location summary
summary_df <- data %>%
group_by(shot_x, shot_y) %>%
summarise(
attempts = n(),
makes = sum(shot_outcome == "made"),
success_rate = makes / attempts,
.groups = "drop"
) %>%
filter(attempts >= min_attempts) %>%
mutate(
shrunk_rate = (makes + alpha) / (attempts + alpha + beta),
alpha = alpha,
beta = beta,
global_fg = mu
)
return(summary_df)
}
plot_shot_map <- function(summary_df,
title = "Shot Efficiency Heatmap",
size_by_attempts = TRUE) {
library(ggplot2)
p <- ggplot(
summary_df,
aes(
x = shot_x,
y = shot_y,
color = shrunk_rate
)
)
# Optionally size points by attempts
if (size_by_attempts) {
p <- p + geom_point(aes(size = attempts), alpha = 0.75)
} else {
p <- p + geom_point(alpha = 0.75, size = 3)
}
p +
scale_color_viridis_c(option = "magma") +
coord_fixed() +
labs(
title = title,
x = "shot_x",
y = "shot_y",
color = "Shrunk FG%",
size = if (size_by_attempts) "Attempts" else NULL
) +
theme_minimal()
}
model <- glm(
cbind(makes, attempts - makes) ~ attempts,
data = shot_summary,
family = binomial()
)
summary(model)
